<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CloudPaste PWA 功能测试</title>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#0ea5e9" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        line-height: 1.6;
        color: #333;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #0ea5e9, #3b82f6);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .content {
        padding: 30px;
      }

      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .test-card {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .test-card:hover {
        border-color: #0ea5e9;
        transform: translateY(-2px);
      }

      .test-card h3 {
        color: #1e293b;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ef4444;
        transition: background 0.3s ease;
      }

      .status-indicator.success {
        background: #10b981;
      }

      .status-indicator.warning {
        background: #f59e0b;
      }

      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .test-result.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .test-result.error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .test-result.warning {
        background: #fefce8;
        color: #92400e;
        border: 1px solid #fde68a;
      }

      .test-result.info {
        background: #eff6ff;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 30px 0;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: #0ea5e9;
        color: white;
      }

      .btn-primary:hover {
        background: #0284c7;
        transform: translateY(-1px);
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-warning:hover {
        background: #d97706;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      .log-container {
        background: #1e293b;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 5px 0;
        border-bottom: 1px solid #334155;
      }

      .log-timestamp {
        color: #64748b;
        margin-right: 10px;
      }

      .log-success {
        color: #10b981;
      }

      .log-error {
        color: #ef4444;
      }

      .log-warning {
        color: #f59e0b;
      }

      .log-info {
        color: #0ea5e9;
      }

      .pwa-status {
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .offline-indicator {
        position: fixed;
        bottom: 80px;
        right: 16px;
        background: #f59e0b;
        color: white;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }

      .offline-indicator.show {
        transform: translateX(0);
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
          border-radius: 8px;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .content {
          padding: 20px;
        }

        .test-grid {
          grid-template-columns: 1fr;
        }

        .button-group {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="offline-indicator" id="offlineIndicator">
      <div style="display: flex; align-items: center; gap: 4px">
        <span>⚠️</span>
        <span>离线模式</span>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <h1>🚀 CloudPaste PWA 测试</h1>
        <p>Progressive Web App 功能完整测试页面</p>
      </div>

      <div class="content">
        <!-- PWA 状态概览 -->
        <div class="pwa-status">
          <h2>📊 PWA 状态概览</h2>
          <div class="status-grid" id="statusGrid">
            <div class="status-item">
              <span>网络状态</span>
              <span id="networkStatus">检测中...</span>
            </div>
            <div class="status-item">
              <span>Service Worker</span>
              <span id="swStatus">检测中...</span>
            </div>
            <div class="status-item">
              <span>可安装</span>
              <span id="installableStatus">检测中...</span>
            </div>
            <div class="status-item">
              <span>已安装</span>
              <span id="installedStatus">检测中...</span>
            </div>
          </div>
        </div>

        <!-- 测试项目 -->
        <div class="test-grid">
          <div class="test-card">
            <h3>
              <span class="status-indicator" id="manifestIndicator"></span>
              Web App Manifest
            </h3>
            <div id="manifestResult">正在检测...</div>
            <button class="btn btn-primary" onclick="testManifest()">测试 Manifest</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="swIndicator"></span>
              Service Worker
            </h3>
            <div id="swResult">正在检测...</div>
            <button class="btn btn-primary" onclick="testServiceWorker()">测试 Service Worker</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="cacheIndicator"></span>
              缓存功能
            </h3>
            <div id="cacheResult">正在检测...</div>
            <button class="btn btn-primary" onclick="testCache()">测试缓存</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="storageIndicator"></span>
              离线存储
            </h3>
            <div id="storageResult">正在检测...</div>
            <button class="btn btn-primary" onclick="testOfflineStorage()">测试存储</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="installIndicator"></span>
              应用安装
            </h3>
            <div id="installResult">正在检测...</div>
            <button class="btn btn-success" onclick="testInstall()" id="installBtn">测试安装</button>
          </div>

          <div class="test-card">
            <h3>
              <span class="status-indicator" id="notificationIndicator"></span>
              通知权限
            </h3>
            <div id="notificationResult">正在检测...</div>
            <button class="btn btn-primary" onclick="testNotifications()">测试通知</button>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="button-group">
          <button class="btn btn-primary" onclick="runAllTests()">🔄 运行所有测试</button>
          <button class="btn btn-success" onclick="installPWA()" id="installPWABtn" style="display: none">📱 安装应用</button>
          <button class="btn btn-warning" onclick="clearAllCaches()">🗑️ 清理缓存</button>
          <button class="btn btn-warning" onclick="clearTestData()">🧹 清理测试数据</button>
          <button class="btn btn-danger" onclick="unregisterSW()">❌ 注销 SW</button>
          <a href="/" class="btn btn-primary">🏠 返回主页</a>
        </div>

        <!-- 测试日志 -->
        <div>
          <h2>📝 测试日志</h2>
          <div class="log-container" id="logContainer">
            <div class="log-entry">
              <span class="log-timestamp">[初始化]</span>
              <span class="log-info">PWA 测试页面已加载</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 全局变量
      let deferredPrompt;
      let swRegistration;

      // 日志函数
      function addLog(message, type = "info") {
        const logContainer = document.getElementById("logContainer");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.className = "log-entry";
        logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${type}">${message}</span>
            `;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      // 更新状态指示器
      function updateIndicator(id, success) {
        const indicator = document.getElementById(id);
        if (indicator) {
          indicator.className = `status-indicator ${success ? "success" : "error"}`;
        }
      }

      // 更新测试结果
      function updateResult(id, message, type = "info") {
        const result = document.getElementById(id);
        if (result) {
          result.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }
      }

      // 网络状态监听
      function setupNetworkListeners() {
        const updateNetworkStatus = () => {
          const isOnline = navigator.onLine;
          document.getElementById("networkStatus").textContent = isOnline ? "在线" : "离线";
          document.getElementById("offlineIndicator").classList.toggle("show", !isOnline);
          addLog(`网络状态: ${isOnline ? "在线" : "离线"}`, isOnline ? "success" : "warning");
        };

        window.addEventListener("online", updateNetworkStatus);
        window.addEventListener("offline", updateNetworkStatus);
        updateNetworkStatus();
      }

      // 测试 Manifest
      async function testManifest() {
        try {
          const response = await fetch("/manifest.json");
          if (response.ok) {
            const manifest = await response.json();
            updateIndicator("manifestIndicator", true);
            updateResult("manifestResult", `✅ Manifest 加载成功<br>应用名称: ${manifest.name}<br>图标数量: ${manifest.icons?.length || 0}`, "success");
            addLog("Manifest 测试通过", "success");
            return true;
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          updateIndicator("manifestIndicator", false);
          updateResult("manifestResult", `❌ Manifest 加载失败: ${error.message}`, "error");
          addLog(`Manifest 测试失败: ${error.message}`, "error");
          return false;
        }
      }

      // 测试 Service Worker
      async function testServiceWorker() {
        try {
          if ("serviceWorker" in navigator) {
            const registration = await navigator.serviceWorker.getRegistration();
            if (registration) {
              swRegistration = registration;
              updateIndicator("swIndicator", true);
              updateResult("swResult", `✅ Service Worker 已注册<br>状态: ${registration.active ? "活跃" : "未激活"}<br>作用域: ${registration.scope}`, "success");
              addLog("Service Worker 测试通过", "success");
              document.getElementById("swStatus").textContent = "已注册";
              return true;
            } else {
              updateIndicator("swIndicator", false);
              updateResult("swResult", "⚠️ Service Worker 未注册", "warning");
              addLog("Service Worker 未注册", "warning");
              document.getElementById("swStatus").textContent = "未注册";
              return false;
            }
          } else {
            updateIndicator("swIndicator", false);
            updateResult("swResult", "❌ 浏览器不支持 Service Worker", "error");
            addLog("浏览器不支持 Service Worker", "error");
            document.getElementById("swStatus").textContent = "不支持";
            return false;
          }
        } catch (error) {
          updateIndicator("swIndicator", false);
          updateResult("swResult", `❌ Service Worker 测试失败: ${error.message}`, "error");
          addLog(`Service Worker 测试失败: ${error.message}`, "error");
          return false;
        }
      }

      // 测试缓存
      async function testCache() {
        try {
          if ("caches" in window) {
            const cacheNames = await caches.keys();
            const totalCaches = cacheNames.length;

            if (totalCaches > 0) {
              updateIndicator("cacheIndicator", true);
              updateResult(
                "cacheResult",
                `✅ 缓存功能正常<br>缓存数量: ${totalCaches}<br>缓存名称: ${cacheNames.slice(0, 3).join(", ")}${totalCaches > 3 ? "..." : ""}`,
                "success"
              );
              addLog(`发现 ${totalCaches} 个缓存`, "success");
              return true;
            } else {
              updateIndicator("cacheIndicator", false);
              updateResult("cacheResult", "⚠️ 未发现缓存", "warning");
              addLog("未发现缓存", "warning");
              return false;
            }
          } else {
            updateIndicator("cacheIndicator", false);
            updateResult("cacheResult", "❌ 浏览器不支持 Cache API", "error");
            addLog("浏览器不支持 Cache API", "error");
            return false;
          }
        } catch (error) {
          updateIndicator("cacheIndicator", false);
          updateResult("cacheResult", `❌ 缓存测试失败: ${error.message}`, "error");
          addLog(`缓存测试失败: ${error.message}`, "error");
          return false;
        }
      }

      // 测试离线存储
      async function testOfflineStorage() {
        // 首先测试 localStorage 作为基础存储
        try {
          const testKey = "pwa_test_" + Date.now();
          const testValue = "PWA测试数据";

          localStorage.setItem(testKey, testValue);
          const retrievedValue = localStorage.getItem(testKey);
          localStorage.removeItem(testKey);

          if (retrievedValue === testValue) {
            addLog("localStorage 测试通过", "success");
          } else {
            addLog("localStorage 测试失败", "warning");
          }
        } catch (error) {
          addLog(`localStorage 测试失败: ${error.message}`, "warning");
        }

        // 然后测试 IndexedDB
        return new Promise((resolve) => {
          try {
            if ("indexedDB" in window) {
              // 测试 IndexedDB
              const testData = { key: "test", value: "PWA测试数据", timestamp: Date.now() };

              const request = indexedDB.open("PWATestDB", 1);

              request.onupgradeneeded = (event) => {
                const db = event.target.result;
                // 删除旧的存储（如果存在）
                if (db.objectStoreNames.contains("testStore")) {
                  db.deleteObjectStore("testStore");
                }
                // 创建新的存储
                db.createObjectStore("testStore", { keyPath: "key" });
                addLog("IndexedDB 数据库升级完成", "info");
              };

              request.onsuccess = (event) => {
                const db = event.target.result;

                try {
                  const transaction = db.transaction(["testStore"], "readwrite");
                  const store = transaction.objectStore("testStore");

                  // 写入数据
                  const putRequest = store.put(testData);

                  putRequest.onsuccess = () => {
                    // 读取数据
                    const getRequest = store.get("test");

                    getRequest.onsuccess = () => {
                      const result = getRequest.result;

                      addLog(`IndexedDB 读取结果: ${JSON.stringify(result)}`, "info");
                      addLog(`期望数据: ${JSON.stringify(testData)}`, "info");

                      if (result && result.value === testData.value) {
                        updateIndicator("storageIndicator", true);
                        updateResult("storageResult", "✅ 离线存储功能正常<br>localStorage: 通过<br>IndexedDB: 通过<br>存储数据: " + result.value, "success");
                        addLog("IndexedDB 测试通过", "success");
                        db.close();
                        resolve(true);
                      } else {
                        updateIndicator("storageIndicator", false);
                        updateResult(
                          "storageResult",
                          `❌ IndexedDB 数据读写不匹配<br>期望: ${testData.value}<br>实际: ${result ? result.value : "null"}<br>localStorage: 通过`,
                          "error"
                        );
                        addLog(`IndexedDB 数据不匹配 - 期望: ${testData.value}, 实际: ${result ? result.value : "null"}`, "error");
                        db.close();
                        resolve(false);
                      }
                    };

                    getRequest.onerror = () => {
                      updateIndicator("storageIndicator", false);
                      updateResult("storageResult", "❌ 数据读取失败", "error");
                      addLog("数据读取失败", "error");
                      db.close();
                      resolve(false);
                    };
                  };

                  putRequest.onerror = () => {
                    updateIndicator("storageIndicator", false);
                    updateResult("storageResult", "❌ 数据写入失败", "error");
                    addLog("数据写入失败", "error");
                    db.close();
                    resolve(false);
                  };
                } catch (error) {
                  updateIndicator("storageIndicator", false);
                  updateResult("storageResult", `❌ 事务操作失败: ${error.message}`, "error");
                  addLog(`事务操作失败: ${error.message}`, "error");
                  db.close();
                  resolve(false);
                }
              };

              request.onerror = () => {
                updateIndicator("storageIndicator", false);
                updateResult("storageResult", "❌ IndexedDB 打开失败", "error");
                addLog("IndexedDB 打开失败", "error");
                resolve(false);
              };
            } else {
              updateIndicator("storageIndicator", false);
              updateResult("storageResult", "❌ 浏览器不支持 IndexedDB", "error");
              addLog("浏览器不支持 IndexedDB", "error");
              resolve(false);
            }
          } catch (error) {
            updateIndicator("storageIndicator", false);
            updateResult("storageResult", `❌ 离线存储测试失败: ${error.message}`, "error");
            addLog(`离线存储测试失败: ${error.message}`, "error");
            resolve(false);
          }
        });
      }

      // 测试安装功能
      function testInstall() {
        if (deferredPrompt) {
          updateIndicator("installIndicator", true);
          updateResult("installResult", '✅ 应用可以安装<br>点击"安装应用"按钮进行安装', "success");
          document.getElementById("installPWABtn").style.display = "inline-block";
          addLog("应用可以安装", "success");
          document.getElementById("installableStatus").textContent = "是";
          return true;
        } else if (window.matchMedia("(display-mode: standalone)").matches) {
          updateIndicator("installIndicator", true);
          updateResult("installResult", "✅ 应用已安装<br>当前运行在独立模式", "success");
          addLog("应用已安装", "success");
          document.getElementById("installedStatus").textContent = "是";
          return true;
        } else {
          updateIndicator("installIndicator", false);
          updateResult("installResult", "⚠️ 应用暂时无法安装<br>可能需要满足更多 PWA 条件", "warning");
          addLog("应用暂时无法安装", "warning");
          document.getElementById("installableStatus").textContent = "否";
          return false;
        }
      }

      // 测试通知
      async function testNotifications() {
        try {
          if ("Notification" in window) {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
              updateIndicator("notificationIndicator", true);
              updateResult("notificationResult", "✅ 通知权限已授予", "success");
              addLog("通知权限已授予", "success");

              // 发送测试通知
              new Notification("CloudPaste PWA", {
                body: "通知功能测试成功！",
                icon: "/icons/icon-96.png",
              });

              return true;
            } else {
              updateIndicator("notificationIndicator", false);
              updateResult("notificationResult", "⚠️ 通知权限被拒绝", "warning");
              addLog("通知权限被拒绝", "warning");
              return false;
            }
          } else {
            updateIndicator("notificationIndicator", false);
            updateResult("notificationResult", "❌ 浏览器不支持通知", "error");
            addLog("浏览器不支持通知", "error");
            return false;
          }
        } catch (error) {
          updateIndicator("notificationIndicator", false);
          updateResult("notificationResult", `❌ 通知测试失败: ${error.message}`, "error");
          addLog(`通知测试失败: ${error.message}`, "error");
          return false;
        }
      }

      // 运行所有测试
      async function runAllTests() {
        addLog("开始运行所有测试...", "info");

        const tests = [testManifest, testServiceWorker, testCache, testOfflineStorage, testInstall, testNotifications];

        let passedTests = 0;
        for (const test of tests) {
          try {
            const result = await test();
            if (result) passedTests++;
          } catch (error) {
            addLog(`测试执行错误: ${error.message}`, "error");
          }
          // 添加延迟以便观察测试过程
          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        addLog(`所有测试完成！通过 ${passedTests}/${tests.length} 项测试`, passedTests === tests.length ? "success" : "warning");
      }

      // 安装 PWA
      async function installPWA() {
        if (deferredPrompt) {
          try {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === "accepted") {
              addLog("用户接受了安装", "success");
              document.getElementById("installPWABtn").style.display = "none";
              document.getElementById("installedStatus").textContent = "是";
            } else {
              addLog("用户拒绝了安装", "warning");
            }

            deferredPrompt = null;
          } catch (error) {
            addLog(`安装失败: ${error.message}`, "error");
          }
        } else {
          addLog("无法安装：没有安装提示", "warning");
        }
      }

      // 清理所有缓存
      async function clearAllCaches() {
        try {
          if ("caches" in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map((name) => caches.delete(name)));
            addLog(`已清理 ${cacheNames.length} 个缓存`, "success");

            // 重新测试缓存
            setTimeout(testCache, 1000);
          } else {
            addLog("浏览器不支持缓存清理", "error");
          }
        } catch (error) {
          addLog(`清理缓存失败: ${error.message}`, "error");
        }
      }

      // 注销 Service Worker
      async function unregisterSW() {
        try {
          if ("serviceWorker" in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
              await registration.unregister();
            }
            addLog(`已注销 ${registrations.length} 个 Service Worker`, "success");
            document.getElementById("swStatus").textContent = "已注销";

            // 重新测试 Service Worker
            setTimeout(testServiceWorker, 1000);
          } else {
            addLog("浏览器不支持 Service Worker", "error");
          }
        } catch (error) {
          addLog(`注销 Service Worker 失败: ${error.message}`, "error");
        }
      }

      // 清理测试数据
      async function clearTestData() {
        try {
          // 清理 localStorage 测试数据
          const keys = Object.keys(localStorage);
          const testKeys = keys.filter((key) => key.startsWith("pwa_test_"));
          testKeys.forEach((key) => localStorage.removeItem(key));

          // 清理 IndexedDB 测试数据
          if ("indexedDB" in window) {
            const deleteRequest = indexedDB.deleteDatabase("PWATestDB");
            deleteRequest.onsuccess = () => {
              addLog("IndexedDB 测试数据库已删除", "success");
            };
            deleteRequest.onerror = () => {
              addLog("删除 IndexedDB 测试数据库失败", "warning");
            };
          }

          addLog(`已清理 ${testKeys.length} 个 localStorage 测试项`, "success");

          // 重新测试存储
          setTimeout(testOfflineStorage, 1000);
        } catch (error) {
          addLog(`清理测试数据失败: ${error.message}`, "error");
        }
      }

      // 页面加载完成后初始化
      window.addEventListener("load", () => {
        addLog("页面加载完成，开始初始化...", "info");

        // 设置网络状态监听
        setupNetworkListeners();

        // 监听安装提示
        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;
          addLog("检测到安装提示", "success");
          document.getElementById("installPWABtn").style.display = "inline-block";
        });

        // 监听应用安装
        window.addEventListener("appinstalled", () => {
          addLog("应用已成功安装", "success");
          document.getElementById("installedStatus").textContent = "是";
          document.getElementById("installPWABtn").style.display = "none";
        });

        // 检查是否已安装
        if (window.matchMedia("(display-mode: standalone)").matches) {
          document.getElementById("installedStatus").textContent = "是";
          addLog("检测到应用已安装（独立模式）", "success");
        }

        // 自动运行测试
        setTimeout(runAllTests, 1000);
      });
    </script>
  </body>
</html>
